{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="bg-dark min-h-screen flex items-center justify-center py-5">
    <div class="w-full flex justify-center items-center py-5 px-5 md:px-40">
        
        <div class="w-full max-w-[960px] flex flex-col items-center">
            
            <div class="w-full flex justify-center px-4 pt-5 pb-3">
                <h1 class="text-[28px] font-bold text-white text-center leading-[1.25em]">
                    Join the Shoeverse and step into your next style.
                </h1>
            </div>

            <form method="POST" id="signupForm" class="w-full max-w-[480px] flex flex-col items-stretch px-4">
                {% csrf_token %}

                <div class="w-full mb-4">
                    <input 
                        type="text" 
                        name="fullName"
                        placeholder="Full Name"
                        class="form-input w-full h-14 bg-dark-green text-white placeholder-muted text-base px-4 py-4 rounded-card border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary transition-all"
                        required
                    >
                </div>

                <div class="w-full mb-4">
                    <input 
                        type="email" 
                        name="email"
                        placeholder="Email Address"
                        class="form-input w-full h-14 bg-dark-green text-white placeholder-muted text-base px-4 py-4 rounded-card border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary transition-all"
                        required
                    >
                </div>

                <div class="w-full mb-2 relative">
                    <input 
                        type="password" 
                        id="password"
                        name="password"
                        placeholder="Password"
                        class="form-input w-full h-14 bg-dark-green text-white placeholder-muted text-base px-4 py-4 rounded-card border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary transition-all"
                        required
                    >
                    <button type="button" class="togglePass absolute right-4 top-[18px] text-muted text-sm hover:text-white transition-colors">Show</button>
                </div>

                <div class="w-full mb-4 px-1">
                    <div class="h-1.5 w-full bg-gray-700 rounded-full overflow-hidden">
                        <div id="strengthBar" class="h-full w-0 transition-all duration-300"></div>
                    </div>
                    <p id="strengthText" class="text-[10px] mt-2 text-muted uppercase tracking-widest font-bold min-h-[15px]"></p>
                </div>

                <div class="w-full mb-4 relative">
                    <input 
                        type="password" 
                        id="confirm_password"
                        name="confirm_password"
                        placeholder="Confirm Password"
                        class="form-input w-full h-14 bg-dark-green text-white placeholder-muted text-base px-4 py-4 rounded-card border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary transition-all"
                        required
                    >
                    <button type="button" class="togglePass absolute right-4 top-[18px] text-muted text-sm hover:text-white transition-colors">Show</button>
                </div>

                <div class="w-full mb-6">
                    <input 
                        type="text" 
                        name="referral"
                        placeholder="Referral Code (Optional)" 
                        class="form-input w-full h-14 bg-dark-green text-white placeholder-muted text-base px-4 py-4 rounded-card border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary transition-all
                            {% if referral_code %} cursor-not-allowed opacity-80 {% endif %}"
                        value="{{ referral_code|default:'' }}"
                        {% if referral_code %} readonly {% endif %}
                    >
                </div>

                <div class="w-full mb-3">
                    <button 
                        id="signupBtn"
                        type="submit"
                        disabled
                        class="w-full h-14 bg-primary text-dark font-bold text-sm rounded-card opacity-50 cursor-not-allowed transition-all hover:scale-[1.01] active:scale-95">
                        Sign Up
                    </button>
                </div>
            </form>

            <div class="w-full flex justify-center items-center my-6 px-4">
                <div class="h-[1px] bg-gray-700 flex-grow"></div>
                <span class="text-small text-muted px-4">OR</span>
                <div class="h-[1px] bg-gray-700 flex-grow"></div>
            </div>

           <div class="w-full max-w-[480px] px-4 mb-3">
                <a href="/accounts/google/login/" 
                class="w-full h-14 bg-dark-green text-white font-bold text-sm rounded-card 
                        flex items-center justify-center gap-3 border border-gray-700 hover:bg-gray-800 transition-all">
                    <img src="{% static 'images/google-icon.svg' %}" alt="Google icon" class="w-[22px] h-[22px]">
                    <span>Continue with Google</span>
                </a>
            </div>

            <div class="w-full flex justify-center mt-4 px-4 pb-3">
                <p class="text-small text-muted text-center">
                    Already have an account?
                    <a href="/login/" class="text-primary font-bold hover:underline ml-1">
                        Log in
                    </a>
                </p>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {

    function clearErrors(field) {
        let input = $(`input[name='${field}']`);
        input.removeClass("border-red-500");
        input.parent().find(".error-text").remove();
    }

    function showError(field, msg) {
        let input = $(`input[name='${field}']`);
        if (!input.parent().find(".error-text").length) {
            input.addClass("border-red-500");
            input.after(`<p class="error-text text-red-500 text-[12px] mt-1 ml-1 font-medium">${msg}</p>`);
        }
    }

    function checkPasswordStrength(password) {
        const bar = $("#strengthBar");
        const text = $("#strengthText");
        
        if (!password) {
            bar.css("width", "0%").removeClass().addClass("h-full bg-gray-700");
            text.text("");
            return false;
        }

        let missing = [];
        if (password.length < 8) missing.push("8+ chars");
        if (!/[A-Z]/.test(password)) missing.push("Uppercase");
        if (!/[0-9]/.test(password)) missing.push("Number");
        if (!/[^A-Za-z0-9]/.test(password)) missing.push("Special");

        let score = 4 - missing.length;
        
        // Update Bar Width and Colors
        const widths = ["10%", "25%", "50%", "75%", "100%"];
        const colors = ["bg-red-600", "bg-red-500", "bg-orange-500", "bg-yellow-500", "bg-green-500"];
        const textColors = ["text-red-600", "text-red-500", "text-orange-500", "text-yellow-500", "text-green-500"];

        bar.css("width", widths[score])
           .removeClass("bg-gray-700 bg-red-600 bg-red-500 bg-orange-500 bg-yellow-500 bg-green-500")
           .addClass(colors[score]);

        if (score === 4) {
            text.text("Strong Password").removeClass().addClass(`text-[10px] mt-2 uppercase tracking-widest font-bold ${textColors[score]}`);
        } else {
            text.text("Required: " + missing.join(", ")).removeClass().addClass(`text-[10px] mt-2 uppercase tracking-widest font-bold ${textColors[score]}`);
        }

        return score === 4;
    }

    function validateForm() {
        let name = $("input[name='fullName']").val().trim();
        let email = $("input[name='email']").val().trim();
        let pass = $("input[name='password']").val().trim();
        let cpass = $("input[name='confirm_password']").val().trim();
        let valid = true;

        // Name Validation
        let nameRegex = /^[a-zA-Z\s]*$/;
        if (name.length > 0) {
            if (name.length < 3 || !nameRegex.test(name)) {
                showError("fullName", "Enter a valid name (min 3 letters)");
                valid = false;
            } else { clearErrors("fullName"); }
        } else { valid = false; }

        // Email Validation
        let emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email.length > 0) {
            if (!emailRegex.test(email)) {
                showError("email", "Enter a valid email");
                valid = false;
            } else { clearErrors("email"); }
        } else { valid = false; }

        // Password Logic
        let isStrong = checkPasswordStrength(pass);
        if (!isStrong) valid = false;

        // Match Logic
        if (cpass.length > 0) {
            if (pass !== cpass) {
                showError("confirm_password", "Passwords do not match");
                valid = false;
            } else { clearErrors("confirm_password"); }
        } else { valid = false; }

        // Final Button state
        if (valid && name.length >= 3 && isStrong && pass === cpass) {
            $("#signupBtn").prop("disabled", false).removeClass("opacity-50 cursor-not-allowed").addClass("opacity-100 cursor-pointer");
        } else {
            $("#signupBtn").prop("disabled", true).addClass("opacity-50 cursor-not-allowed").removeClass("opacity-100 cursor-pointer");
        }
    }

    $("input").on("input focusout", validateForm);

    $(".togglePass").on("click", function () {
        let input = $(this).closest('div').find('input');
        let isPass = input.attr("type") === "password";
        input.attr("type", isPass ? "text" : "password");
        $(this).text(isPass ? "Hide" : "Show");
    });
});
</script>
{% endblock content %}