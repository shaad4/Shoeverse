{% extends "base.html" %}

{% block content %}

<div class="w-full min-h-screen flex flex-col items-center pt-28 pb-10 bg-dark">

    <div class="w-full max-w-[480px] px-5 py-10 bg-dark flex flex-col items-center">

        <h1 class="text-[28px] font-bold text-white text-center mb-6">
            Enter the OTP
        </h1>

        {% if messages %}
            <div class="mb-4 w-full">
                {% for message in messages %}
                    <div class="p-3 rounded-card text-white text-sm font-medium
                        {% if message.tags == 'error' %} bg-red-500 
                        {% elif message.tags == 'success' %} bg-green-600 
                        {% else %} bg-dark-green 
                        {% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <p class="text-muted mb-6 text-center">
            Verification code sent to <span class="text-white font-semibold">{{ email }}</span>.
        </p>

        <form method="POST" class="w-full">
            {% csrf_token %}
            <input 
                type="text"
                name="otp"
                inputmode="numeric"
                pattern="[0-9]*"
                placeholder="Enter your OTP"
                class="w-full h-14 bg-dark-green text-white placeholder-muted px-4 rounded-card border border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary mb-4 text-center text-xl tracking-[0.5em] font-bold"
                required
            >

            <button type="submit" class="w-full h-12 bg-primary text-dark font-bold rounded-card hover:opacity-90 transition-all active:scale-95">
                Confirm
            </button>
        </form>

        <div class="mt-8 flex flex-col items-center">
            <p id="resend-text" class="text-sm text-muted text-center hidden">
                Resend OTP in <span id="timer" class="text-primary font-bold">02:00</span>
            </p>

            <a id="resend-btn"
               href="{% url 'resend_otp' %}"
               class="text-primary font-bold hover:underline hidden transition-all">
                Resend OTP
            </a>
        </div>

    </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const timerDuration = 120; // 2 Minutes
        const timerSpan = document.getElementById("timer");
        const resendText = document.getElementById("resend-text");
        const resendBtn = document.getElementById("resend-btn");

        // Helper to format seconds into MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function startTimer() {
            // Get existing target time from storage
            let expiryTime = localStorage.getItem("otpExpiryTime");
            let now = Math.floor(Date.now() / 1000);

            // If no timer exists or it has already expired, set a new one
            if (!expiryTime || now > expiryTime) {
                expiryTime = now + timerDuration;
                localStorage.setItem("otpExpiryTime", expiryTime);
            }

            const countdown = setInterval(() => {
                let currentTime = Math.floor(Date.now() / 1000);
                let timeLeft = expiryTime - currentTime;

                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    resendText.classList.add("hidden");
                    resendBtn.classList.remove("hidden");
                    localStorage.removeItem("otpExpiryTime");
                } else {
                    resendText.classList.remove("hidden");
                    resendBtn.classList.add("hidden");
                    timerSpan.textContent = formatTime(timeLeft);
                }
            }, 1000);
        }

        // Initialize timer
        startTimer();

        // Clear timer if user successfully clicks resend
        resendBtn.addEventListener("click", function() {
            localStorage.removeItem("otpExpiryTime");
        });
    });
</script>

{% endblock content %}