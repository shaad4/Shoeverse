{% extends "base.html" %}
{% load static %}

{% block title %}Secure Checkout | Shoeverse{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-[#121714] text-gray-200 font-sans relative overflow-hidden items-center justify-center p-4">

    <!-- Background Ambient Glow -->
    <div class="absolute top-0 right-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[10%] right-[20%] w-96 h-96 bg-[#366347]/10 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[10%] left-[10%] w-[500px] h-[500px] bg-[#1a2e22]/20 rounded-full blur-[120px]"></div>
    </div>

    <div class="relative z-10 w-full max-w-md">

        <div class="absolute -top-12 left-1/2 -translate-x-1/2 w-32 h-32 bg-[#366347] rounded-full blur-[60px] opacity-40"></div>

        <div class="bg-[#18211d] rounded-3xl border border-[#2a3b31] shadow-[0_0_50px_rgba(0,0,0,0.5)] overflow-hidden backdrop-blur-sm relative">

            <div class="relative p-8 z-10">

                <!-- Header -->
                <div class="text-center mb-8">
                    <div class="w-14 h-14 bg-[#366347]/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-[#366347]/20 text-[#366347]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Confirm Transaction</h2>
                    <p class="text-sm text-gray-500 mt-1">Secure Payment Gateway</p>
                </div>

                <!-- Amount -->
                <div class="flex flex-col items-center justify-center py-8 bg-[#121714]/50 rounded-2xl border border-[#2a3b31] mb-8">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-2">Total Amount</p>
                    <div class="flex items-start">
                        <span class="text-2xl font-medium text-[#366347] mt-2 mr-1">₹</span>
                        <span class="text-5xl font-bold text-white">{{ payment.amount }}</span>
                    </div>
                </div>

                <!-- Details -->
                <div class="space-y-4 text-sm mb-8">
                    <div class="flex justify-between pb-3 border-b border-[#2a3b31]">
                        <span class="text-gray-500">Reference ID</span>
                        <span class="text-gray-300 font-mono">{{ order.id }}</span>
                    </div>
                    <div class="flex justify-between pb-3 border-b border-[#2a3b31]">
                        <span class="text-gray-500">Account</span>
                        <span class="text-white font-medium">{{ user.fullName }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Merchant</span>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-[#366347]"></span>
                            <span class="text-gray-300">Shoeverse Wallet</span>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="space-y-3">

                    <button id="rzp-button" class="w-full group relative flex items-center justify-center py-4 px-6 text-sm font-semibold rounded-xl text-white bg-[#366347] hover:bg-[#2d523b]">
                        <span id="btn-text">Pay Now Securely</span>
                        <span id="btn-spinner" class="hidden absolute right-4">
                            <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke-width="4"></circle>
                                <path class="opacity-75" d="M4 12a8 8 0 018-8V0..."></path>
                            </svg>
                        </span>
                    </button>

                    <a href="#" onclick="history.back()" class="block w-full py-4 text-sm text-gray-500 hover:text-white text-center">
                        Cancel Transaction
                    </a>

                </div>

            </div>
        </div>
    </div>
</div>

<!-- Razorpay JS -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    var options = {
        "key": "{{ razorpay_key_id }}",
        "amount": "{{ order.amount }}",
        "currency": "INR",
        "name": "Shoeverse Wallet",
        "order_id": "{{ order.id }}",

        // SUCCESS HANDLER
        "handler": function (response) {
            window.location.href =
                `{% url 'wallet_payment_success' %}?payment_id=${response.razorpay_payment_id}&order_id=${response.razorpay_order_id}&signature=${response.razorpay_signature}`;
        },

        "prefill": {
            "name": "{{ user.fullName }}",
            "email": "{{ user.email }}",
            "contact": "{{ user.phoneNumber|default:'' }}"
        },

        "theme": { "color": "#366347" },

        // CANCEL HANDLER
        "modal": {
            "ondismiss": function () {
                window.location.href = "{% url 'wallet_payment_failed' %}";
            }
        }
    };

    var rzp1 = new Razorpay(options);

    // EXTRA — Catches *bank decline*, *QR close*, *UPI fail*
    rzp1.on('payment.failed', function () {
        window.location.href = "{% url 'wallet_payment_failed' %}";
    });

    document.getElementById('rzp-button').onclick = function (e) {
        e.preventDefault();
        rzp1.open();
    }
</script>

{% endblock %}
