{% extends "shop/base_shop.html" %}
{% load static %}

{% block title %}{{ product.name }} - Shoeverse{% endblock %}

{% block content %}

<section class="max-w-container mx-auto px-5 md:px-10 lg:px-20 pt-10 pb-20 text-white">

    <nav aria-label="breadcrumb" class="text-small text-muted mb-6 uppercase tracking-[0.18em]">
        <ol class="flex items-center gap-2">
            <li><a href="{% url 'shop_products' %}" class="hover:text-primary transition-colors">Products</a></li>
            <li>/</li>
            <li><a href="{% url 'shop_products' %}?category={{ product.category|lower }}" 
                   class="hover:text-primary transition-colors">
                {{ product.category|title }}
            </a></li>
            <li>/</li>
            <li class="text-white font-medium">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="grid lg:grid-cols-[1.1fr_1fr] gap-10 lg:gap-16">

        <div class="space-y-6">

            <div id="mainImageWrapper"
                class="relative aspect-square rounded-[20px] overflow-hidden bg-[#18211d] flex items-center justify-center cursor-crosshair group border border-[#2a3b31]">
                
                <img id="mainImage"
                    src="{{ product.images.first.image.url }}"
                    alt="{{ product.name }}"
                    class="w-full h-full object-cover transition-transform duration-200 ease-out origin-center will-change-transform">

                 <div class="absolute top-4 right-4 pointer-events-none group-hover:opacity-0 transition-opacity duration-300">
                    <span class="bg-[#121714]/80 text-white text-xs px-3 py-1.5 rounded-full border border-[#2a3b31] backdrop-blur-md shadow-lg flex items-center gap-2">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                        Hover to Zoom
                    </span>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-4">
                {% for img in product.images.all %}
                <button 
                    class="thumbBtn aspect-square rounded-[14px] overflow-hidden bg-[#18211d] border 
                           {% if forloop.first %}border-[#96c4a8] ring-1 ring-[#96c4a8]{% else %}border-[#2a3b31]{% endif %} 
                           hover:border-[#96c4a8] transition p-1"
                    onclick="swapImage('{{ img.image.url }}', this)">
                    
                    <img src="{{ img.image.url }}"
                        class="w-full h-full object-cover rounded-lg">
                </button>
                {% endfor %}
            </div>

        </div>


        <div class="flex flex-col gap-8">

            <div class="space-y-4">
                <h1 class="text-3xl md:text-4xl font-bold leading-tight">{{ product.name }}</h1>

                <div class="flex items-center gap-4 text-sm text-gray-400">
                    
                    {% if avg_rating > 0 %}
                    <div class="flex items-center gap-2 bg-[#2a3b31] border border-[#3d5244] px-3 py-1.5 rounded-full">
                        <span class="font-bold text-white">{{ avg_rating }}</span>
                        <div class="flex text-yellow-400 text-xs gap-0.5">
                            {% for i in "12345" %}
                                {% if avg_rating >= forloop.counter %}
                                    <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                {% else %}
                                    <svg class="w-3.5 h-3.5 text-gray-600 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <a href="#reviews" class="text-[#96c4a8] hover:text-white hover:underline decoration-[#96c4a8]/50 underline-offset-4 transition-colors cursor-pointer font-medium">
                        {{ review_count }} Reviews
                    </a>
                </div>

                <p class="text-gray-400 text-sm leading-relaxed max-w-xl border-l-2 border-[#2a3b31] pl-4">
                    {{ product.description }}
                </p>
            </div>


            <div class="flex items-baseline gap-4 mt-2">

                {% if product.offer_percentage > 0 %}
                    
                    <!-- Final (Discounted) Price -->
                    <p class="text-4xl font-bold text-[#96c4a8]">
                        ₹ {{ product.final_price }}
                    </p>

                    <!-- Original MRP -->
                    <p class="line-through text-gray-500 text-lg">
                        ₹ {{ product.price }}
                    </p>

                    <!-- Offer Badge -->
                    <span class="ml-2 px-3 py-1 bg-[#96c4a8]/10 text-[#96c4a8] font-bold rounded-full text-sm tracking-wide">
                        {{ product.offer_percentage }}% OFF
                    </span>

                {% else %}
                    <!-- No Offer -->
                    <p class="text-4xl font-bold text-white">
                        ₹ {{ product.price }}
                    </p>
                {% endif %}

            </div>



            {% if product.color %}
            <div class="space-y-3">
                <p class="uppercase tracking-widest text-xs font-bold text-gray-500">Color</p>
                <div class="flex items-center gap-3 bg-[#18211d] w-fit px-4 py-2 rounded-lg border border-[#2a3b31]">
                    <span class="w-4 h-4 rounded-full border border-gray-600 shadow-sm" style="background-color: {{ product.color|lower }}"></span>
                    <span class="text-white font-medium capitalize">
                        {{ product.color }}
                    </span>
                </div>
            </div>
            {% endif %}


            <form method="POST" action="{% url 'add_to_cart' 0 %}" id="addToCartForm">
                {% csrf_token %}

                <div class="space-y-3 mb-8">
                    <div class="flex justify-between items-end">
                        <p class="uppercase tracking-widest text-xs font-bold text-gray-500">Select Size</p>
                        
                    </div>

                    <div class="grid grid-cols-3 sm:grid-cols-5 gap-3">
                        {% for variant in variants %}
                            <label class="relative cursor-pointer block group">
                                <input type="radio" 
                                    name="variant_id" 
                                    value="{{ variant.id }}" 
                                    required
                                    {% if variant.stock <= 0 %}disabled{% endif %}
                                    class="peer hidden">

                                <span class="rounded-xl py-3.5 block text-center border font-medium transition-all duration-200
                                            {% if variant.stock <= 0 %}
                                                bg-[#18211d] border-[#2a3b31] text-gray-600 opacity-50 cursor-not-allowed decoration-slice line-through
                                            {% else %}
                                                bg-[#18211d] border-[#2a3b31] text-gray-300 hover:border-[#96c4a8] peer-checked:bg-[#96c4a8] peer-checked:text-[#121714] peer-checked:border-[#96c4a8] peer-checked:shadow-[0_0_15px_rgba(150,196,168,0.3)]
                                            {% endif %}">
                                    {{ variant.size }}
                                </span>
                            </label>
                        {% endfor %}
                    </div>
                </div>


                <div class="flex flex-col sm:flex-row items-stretch gap-4">
        
                    <div class="flex-shrink-0">
                        <p class="uppercase text-xs font-bold tracking-widest text-gray-500 mb-2">Quantity</p>
                        <div class="h-14 flex items-center justify-between bg-[#18211d] border border-[#2a3b31] rounded-xl px-2 w-32">
                            <button type="button" onclick="changeQty(-1)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-white hover:bg-[#2a3b31] rounded transition text-lg">−</button>
                            <input type="text" id="qty-input" name="quantity" value="1" class="w-8 text-center bg-transparent text-white font-bold focus:outline-none" readonly>
                            <button type="button" onclick="changeQty(1)" class="w-8 h-8 flex items-center justify-center text-[#96c4a8] hover:text-white hover:bg-[#2a3b31] rounded transition text-lg">+</button>
                        </div>
                    </div>

                    <div class="flex-1">
                         <p class="uppercase text-xs font-bold tracking-widest text-transparent mb-2 select-none">Action</p>
                        {% if is_out_of_stock %}
                            <button type="button" class="w-full h-14 bg-red-900/20 border border-red-900/30 text-red-400 font-bold rounded-xl cursor-not-allowed flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                                Out of Stock
                            </button>
                        {% else %}
                            <button type="submit" 
                                class="w-full h-14 bg-[#96c4a8] hover:bg-[#85b095] text-[#121714] font-bold text-lg rounded-xl transition-all transform active:scale-[0.98] shadow-lg shadow-[#96c4a8]/20 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                                Add to Cart
                            </button>
                        {% endif %}
                    </div>
                
                </div>
            </form> <form method="POST" action="{% url 'add_to_wishlist' product.id %}" class="mt-2">
                {% csrf_token %}
                <button type="submit" 
                    class="w-full h-12 rounded-xl border flex items-center justify-center gap-2 transition-all duration-300 group
                    {% if is_in_wishlist %}
                        bg-[#18211d] border-[#96c4a8] text-[#96c4a8]
                    {% else %}
                        bg-transparent border-[#2a3b31] text-gray-400 hover:border-[#96c4a8] hover:text-white
                    {% endif %}">
                    
                    {% if is_in_wishlist %}
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        <span>Saved to Wishlist</span>
                    {% else %}
                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        <span>Add to Wishlist</span>
                    {% endif %}
                </button>
            </form>

            <div class="grid md:grid-cols-2 gap-6 bg-[#18211d] border border-[#2a3b31] rounded-[20px] p-6 mt-4">
                <div>
                    <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-[#96c4a8]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Highlights
                    </h3>
                    {% if product.highlights %}
                    <ul class="space-y-2 text-sm text-gray-400 list-disc list-inside marker:text-[#96c4a8]">
                        {% for item in product.highlights.splitlines %}
                            {% if item.strip %}<li>{{ item }}</li>{% endif %}
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-sm text-gray-500 italic">No highlights available.</p>
                    {% endif %}
                </div>

                <div>
                    <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5 text-[#96c4a8]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Specifications
                    </h3>
                    {% if product.specifications %}
                    <pre class="whitespace-pre-line text-sm text-gray-400 font-sans">{{ product.specifications }}</pre>
                    {% else %}
                    <p class="text-sm text-gray-500 italic">No specifications available.</p>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>


    <section id="reviews" class="mt-24 border-t border-[#2a3b31] pt-16">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-10 gap-4">
            <div>
                <h2 class="text-2xl font-bold text-white">Customer Reviews</h2>
                <p class="text-gray-400 text-sm mt-1">Based on recent purchases</p>
            </div>
            
            {% if can_review %}
                <a href="{% url 'submit_review' product.id %}" 
                   class="inline-flex items-center gap-2 bg-transparent border border-[#96c4a8] text-[#96c4a8] hover:bg-[#96c4a8] hover:text-[#121714] font-bold py-2.5 px-6 rounded-xl transition-all duration-300">
                   {% if user_review %}
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        Edit Your Review
                   {% else %}
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Write a Review
                   {% endif %}
                </a>
            {% endif %}
        </div>

        <div class="grid lg:grid-cols-[350px_1fr] gap-12">

            <div class="space-y-8 h-fit lg:sticky lg:top-24">
                
                <div class="rounded-2xl bg-[#18211d] border border-[#2a3b31] p-8 text-center shadow-lg">
                    <p class="text-xs text-gray-500 uppercase font-bold tracking-widest mb-4">Overall Rating</p>
                    
                    <div class="flex items-center justify-center gap-4 mb-2">
                        <span class="text-6xl font-bold text-white">{{ avg_rating }}</span>
                        <div class="text-left">
                            <div class="flex text-yellow-400 text-lg gap-0.5">
                                {% for i in "12345" %}
                                    {% if avg_rating >= forloop.counter %}
                                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                    {% else %}
                                        <svg class="w-5 h-5 text-gray-600 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="text-sm text-gray-400 block mt-1">{{ review_count }} global ratings</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 px-2">
                    {% for star, count in star_distribution.items %}
                    <div class="flex items-center gap-4 text-sm group">
                        <span class="w-12 text-white font-medium flex-shrink-0">{{ star }} Star</span>
                        
                        <div class="flex-1 h-2.5 bg-[#121714] rounded-full overflow-hidden border border-[#2a3b31]">
                            <div class="h-full bg-yellow-400 rounded-full transition-all duration-1000 ease-out group-hover:bg-yellow-300" 
                                 style="width: {% widthratio count review_count 100 %}%;">
                            </div>
                        </div>
                        
                        <span class="w-10 text-right text-gray-500 tabular-nums">
                            {% widthratio count review_count 100 %}%
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>


            <div class="space-y-6">
                {% if reviews %}
                    {% for review in reviews %}
                    <div class="rounded-2xl bg-[#18211d] border border-[#2a3b31] p-6 hover:border-gray-600 transition-colors">
                        
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="flex-shrink-0">
                                    {% if review.user.profileImage %}
                                        <img src="{{ review.user.profileImage.url }}" 
                                             alt="{{ review.user.fullName }}" 
                                             class="w-10 h-10 rounded-full object-cover border border-[#2a3b31]">
                                    {% else %}
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#2a3b31] to-[#121714] flex items-center justify-center text-[#96c4a8] font-bold text-xs border border-[#2a3b31]">
                                            {{ review.user.fullName|slice:":2" }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <h3 class="font-bold text-white text-sm">{{ review.user.fullName|default:review.user.email }}</h3>
                                    <div class="flex text-yellow-400 text-xs mt-1 gap-0.5">
                                        {% for i in "12345" %}
                                            {% if review.rating|slugify >= i %}
                                                <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                            {% else %}
                                                <svg class="w-3.5 h-3.5 text-gray-600 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <span class="text-xs text-gray-500">{{ review.created_at|date:"M d, Y" }}</span>
                        </div>

                        <div class="flex items-center gap-1.5 text-xs text-[#96c4a8] font-bold uppercase tracking-wide mb-3 bg-[#96c4a8]/10 w-fit px-2 py-1 rounded">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Verified Purchase
                        </div>

                        <p class="text-gray-300 text-sm leading-relaxed font-light">
                            {{ review.comment }}
                        </p>
                    </div>
                    {% endfor %}

                {% else %}
                    <div class="flex flex-col items-center justify-center py-16 text-center border-2 border-dashed border-[#2a3b31] rounded-3xl bg-[#18211d]/50">
                        <div class="w-16 h-16 bg-[#18211d] rounded-full flex items-center justify-center mb-4 border border-[#2a3b31]">
                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                        </div>
                        <h3 class="text-lg font-bold text-white">No reviews yet</h3>
                        <p class="text-gray-400 text-sm mt-1 mb-6">This product hasn't been rated yet. Be the first!</p>
                        
                        {% if can_review %}
                        <a href="{% url 'submit_review' product.id %}" class="text-[#96c4a8] hover:text-white font-bold underline underline-offset-4">Write a Review</a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </section>


    {% if related_products %}
    <section class="mt-24 border-t border-[#2a3b31] pt-16">
        <h2 class="text-2xl font-bold mb-8 text-white">You Might Also Like</h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for p in related_products %}
            <a href="{% url 'product_detail' p.id %}" class="group block">
                <article class="bg-[#18211d] border border-[#2a3b31] rounded-2xl p-4 
                                hover:border-[#96c4a8]/50 hover:shadow-lg hover:-translate-y-1 
                                transition-all duration-300 h-full flex flex-col">

                    <div class="aspect-[4/5] rounded-xl overflow-hidden bg-[#121714] relative mb-4">
                         {% if p.images.first %}
                            <img src="{{ p.images.first.image.url }}" 
                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                         {% endif %}
                    </div>

                    <div class="flex flex-col flex-1">
                        <p class="text-[10px] text-[#96c4a8] uppercase font-bold tracking-wider mb-1">{{ p.category }}</p>
                        <h3 class="text-base font-bold text-white leading-snug group-hover:text-[#96c4a8] transition-colors mb-2">
                            {{ p.name }}
                        </h3>
                        <div class="mt-auto flex items-center gap-2">
                            <p class="text-[#96c4a8] font-bold">₹ {{ p.price }}</p>
                            {% if p.old_price %}
                                <span class="text-xs text-gray-500 line-through">₹ {{ p.old_price }}</span>
                            {% endif %}
                        </div>
                    </div>
                </article>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

</section>

<div id="zoomModal" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 cursor-zoom-out">
    <img id="zoomedImage" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl animate-fade-in-up">
    <button class="absolute top-6 right-6 text-white/70 hover:text-white bg-white/10 rounded-full p-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>
</div>

<script>
    // --- DOM ELEMENTS ---
    const mainImage = document.getElementById("mainImage");
    const container = document.getElementById("mainImageWrapper");
    
    // --- 1. THUMBNAIL SWAP ---
    function swapImage(newSrc, thumbElement) {
        // Fade out
        mainImage.style.opacity = "0";
        
        setTimeout(() => {
            mainImage.src = newSrc;
            mainImage.onload = () => { mainImage.style.opacity = "1"; };
        }, 150);

        // Active styling
        document.querySelectorAll(".thumbBtn").forEach(btn => {
            btn.classList.remove("border-[#96c4a8]", "ring-1", "ring-[#96c4a8]");
            btn.classList.add("border-[#2a3b31]");
        });

        thumbElement.classList.remove("border-[#2a3b31]");
        thumbElement.classList.add("border-[#96c4a8]", "ring-1", "ring-[#96c4a8]");
    }

    // --- 2. HOVER TO ZOOM LOGIC ---
    if (window.matchMedia("(hover: hover)").matches) {
        container.addEventListener("mousemove", function(e) {
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const xPercent = (x / rect.width) * 100;
            const yPercent = (y / rect.height) * 100;

            mainImage.style.transformOrigin = `${xPercent}% ${yPercent}%`;
            mainImage.style.transform = "scale(2)"; 
        });

        container.addEventListener("mouseleave", function() {
            mainImage.style.transformOrigin = "center center";
            mainImage.style.transform = "scale(1)";
        });
    }

    // --- 3. MOBILE/TABLET ZOOM MODAL ---
    const zoomModal = document.getElementById("zoomModal");
    const zoomedImage = document.getElementById("zoomedImage");

    container.addEventListener("click", function() {
        // Only if not hover capable (Touch devices) OR force functionality
        if (window.innerWidth < 1024) { 
            zoomedImage.src = mainImage.src;
            zoomModal.classList.remove("hidden");
            document.body.style.overflow = 'hidden'; // Lock scroll
        }
    });

    zoomModal.addEventListener("click", () => {
        zoomModal.classList.add("hidden");
        document.body.style.overflow = ''; // Unlock scroll
    });

    // --- 4. QUANTITY LOGIC ---
    function changeQty(amount) {
        let qtyInput = document.getElementById("qty-input");
        let qty = parseInt(qtyInput.value) + amount;
        if (qty < 1) qty = 1;
        if (qty > 4) qty = 4;
        qtyInput.value = qty;
    }
    
    // --- 5. FORM VALIDATION (Size Selection) ---
    const form = document.getElementById('addToCartForm');
    form.addEventListener('submit', function(e) {
        const selectedVariant = document.querySelector('input[name="variant_id"]:checked');
        if (!selectedVariant) {
            e.preventDefault();
            alert('Please select a size before adding to cart.');
        }
    });
</script>

{% endblock %}