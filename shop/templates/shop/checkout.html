{% extends "base.html" %}
{% load static %}

{% block title %} Checkout · Shoeverse {% endblock %}

{% block content %}
<main class="mx-auto max-w-6xl px-4 py-12 lg:px-6">

    <section class="flex flex-col md:flex-row justify-between items-start md:items-center mt-2 mb-8">
        <div class="space-y-3">
            <p class="text-sm uppercase tracking-[0.3em] text-muted">Checkout</p>
            <h1 class="text-3xl md:text-4xl font-semibold">Review your order</h1>
            <p class="text-base text-mint-100/80">
                Confirm delivery details and make sure everything looks perfect before placing your order.
            </p>
        </div>

        <div class="flex items-center gap-3 text-sm mt-6 md:mt-0">
            <div class="flex items-center gap-2">
                <span class="w-8 h-8 rounded-full bg-primary/20 text-primary flex items-center justify-center font-semibold">1</span>
                <span>Cart</span>
            </div>
            <span class="text-white/40">―――</span>
            <div class="flex items-center gap-2">
                <span class="w-8 h-8 rounded-full bg-primary text-dark flex items-center justify-center font-semibold">2</span>
                <span class="text-primary">Checkout</span>
            </div>
            <span class="text-white/40">―――</span>
            <div class="flex items-center gap-2 text-white/40">
                <span class="w-8 h-8 rounded-full border border-white/15 flex items-center justify-center font-semibold">3</span>
                <span>Payment</span>
            </div>
        </div>
    </section>

    <div class="mt-10 grid gap-8 lg:grid-cols-[minmax(0,2fr)_minmax(320px,1fr)]">

        <div class="space-y-8">

            <section class="rounded-3xl border border-primary/30 bg-dark-green/40 px-6 py-6 shadow-card">
                <div class="flex flex-col gap-2 border-b border-white/10 pb-4 sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <p class="text-lg font-semibold text-white">Your Order Details</p>
                        <p class="text-sm text-muted">Your selected items are almost yours.</p>
                    </div>
                    <a href="{% url 'cart' %}" class="text-sm font-medium text-primary hover:text-white transition">
                        Modify Cart
                    </a>
                </div>

                <div class="mt-5 space-y-3 text-sm text-mint-100/80">
                    <div class="grid grid-cols-[minmax(0,2fr)_repeat(3,minmax(0,1fr))] gap-4 bg-forest-800 px-4 py-3 text-xs uppercase tracking-wide text-primary rounded-2xl">
                        <span>Product</span>
                        <span>Price</span>
                        <span>Qty</span>
                        <span>Total</span>
                    </div>

                    {% for item in cart_items %}
                    <div class="grid grid-cols-[minmax(0,2fr)_repeat(3,minmax(0,1fr))] gap-4 bg-forest-800/60 px-4 py-4 rounded-2xl">
                        <div class="flex items-center gap-4">
                            {% if item.variant.product.images.first %}
                            <img src="{{ item.variant.product.images.first.image.url }}" 
                                 alt="{{ item.variant.product.name }}" 
                                 class="h-14 w-14 rounded-2xl border border-white/10 bg-dark-green object-cover" />
                            {% else %}
                            <div class="h-14 w-14 rounded-2xl border border-white/10 bg-dark-green flex items-center justify-center text-xs">No Img</div>
                            {% endif %}
                            <div>
                                <p class="font-semibold text-white">{{ item.variant.product.name }}</p>
                                <p class="text-xs text-muted">Size {{ item.variant.size }}</p>
                            </div>
                        </div>
                        <p class="font-semibold text-white">₹{{ item.variant.product.final_price }}</p>
                        <p class="font-semibold text-white">{{ item.quantity }}</p>
                        <p class="font-semibold text-white">₹{{ item.total_price }}</p>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <section class="space-y-5 rounded-3xl border border-primary/30 bg-dark-green/40 px-6 py-6 shadow-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-lg font-semibold text-white">Select Delivery Address</p>
                        <p class="text-sm text-muted">Choose your drop-off location.</p>
                    </div>
                    <a href="{% url 'address' %}" class="text-sm font-medium text-primary">Manage</a>
                </div>

                <div class="space-y-4">
                    {% if addresses %}
                        {% for address in addresses %}
                        <label class="flex cursor-pointer items-start gap-4 rounded-2xl border
                            {% if address.is_default %} border-primary bg-dark-green/60 {% else %} border-white/10 bg-dark/40 hover:border-primary/60 {% endif %}
                            p-5 transition w-full">

                            <input type="radio" name="address_id" value="{{ address.id }}"
                                class="mt-1 h-4 w-4 accent-primary cursor-pointer"
                                {% if address.is_default %}checked{% endif %} />

                            <div>
                                <p class="text-base font-semibold text-white">{{ address.full_name }}</p>
                                <p class="text-sm text-muted">
                                    {{ address.address_line1 }}, {{ address.city }}, {{ address.state }} - {{ address.pincode }}
                                </p>
                                <p class="text-xs text-white/50 mt-1">Phone: {{ address.phone_number }}</p>
                            </div>
                        </label>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-red-400">You need to add an address to continue.</p>
                    {% endif %}

                    <a href="{% url 'add_address' %}?next=checkout"
                    class="flex w-full items-center justify-center gap-3 rounded-2xl border border-dashed 
                            border-primary/60 bg-dark-green/30 px-4 py-4 text-sm font-semibold text-primary hover:border-primary transition">
                        <span class="flex h-8 w-8 items-center justify-center rounded-full bg-dark-green text-lg">+</span>
                        Add New Address
                    </a>
                </div>
            </section>
        </div>

        <aside class="space-y-6">

            <section class="glass rounded-3xl border border-white/5 p-6 space-y-6 shadow-card bg-dark-green/20">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold">Order Summary</h2>
                    <span class="text-sm text-white/50">{{ total_items }} items</span>
                </div>

                <div class="space-y-4 text-sm">
                    
                    <div class="flex justify-between">
                        <span class="text-white/70">Subtotal</span>
                        <span class="font-semibold text-white">₹{{ subtotal }}</span>
                    </div>

                    <div class="flex justify-between">
                        <span class="text-white/70">GST (18%)</span>
                        <span class="font-semibold text-white">₹{{ gst }}</span>
                    </div>

                    {% if discount_amount > 0 %}
                    <div class="flex justify-between text-emerald-400">
                        <span>Coupon Discount</span>
                        <span class="font-semibold">- ₹{{ discount_amount }}</span>
                    </div>
                    {% endif %}

                    <div class="flex justify-between">
                        <span class="text-white/70">Delivery Charges</span>
                        {% if is_free_delivery %}
                            <span class="text-primary font-semibold">Free</span>
                        {% else %}
                            <span class="font-semibold text-white">₹{{ delivery_charge }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="border-t border-white/10 pt-4 flex items-center justify-between">
                    <span class="text-sm text-white/70">Total</span>
                    <span class="text-2xl font-semibold text-primary">₹{{ grand_total }}</span>
                </div>

                <p class="text-xs text-mint-100/70 mt-1">
                    Estimated Delivery: {{ estimated_delivery_date }}
                </p>
            </section>

            <section class="glass rounded-3xl border border-white/10 bg-dark-green/40 p-5 shadow-card">
                <h2 class="text-sm font-semibold text-white mb-3 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z">
                        </path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                    Have a coupon?
                </h2>

                {% if applied_coupon %}
                    <div class="flex items-center justify-between bg-emerald-500/10 border border-emerald-500/20 p-3 rounded-xl mb-4">
                        <div class="flex flex-col">
                            <span class="text-emerald-300 font-semibold">Coupon Applied: {{ applied_coupon }}</span>
                            <span class="text-xs text-emerald-200">Discount Applied: ₹{{ discount_amount }}</span>
                        </div>

                        <a href="{% url 'remove_coupon' %}"
                        class="text-red-400 hover:text-red-300 text-xs font-semibold underline">
                        Remove
                        </a>
                    </div>
                {% endif %}

                {% if messages %}
                    {% for message in messages %}
                        {% if 'error' in message.tags or 'warning' in message.tags %}
                            <p class="text-red-400 text-xs mb-3">{{ message }}</p>
                        {% elif 'success' in message.tags %}
                            <p class="text-green-400 text-xs mb-3">{{ message }}</p>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if not applied_coupon %}
                <form method="POST" action="{% url 'apply_coupon' %}" class="relative flex items-center">
                    {% csrf_token %}
                    <input type="text"
                        name="coupon_code"
                        placeholder="Enter promo code"
                        class="w-full rounded-xl border border-white/10 bg-dark/40 py-3 pl-4 pr-24 text-sm text-white 
                                placeholder-white/30 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary 
                                transition uppercase" />

                    <button type="submit"
                            class="absolute right-2 top-1.5 bottom-1.5 rounded-lg bg-primary px-4 text-xs font-bold 
                                uppercase tracking-wider text-dark hover:bg-white hover:text-dark transition">
                        Apply
                    </button>
                </form>
                {% endif %}
            </section>

            <button type="button" 
                onclick="goToPayment()" 
                class="w-full rounded-2xl bg-primary py-4 text-base font-semibold text-dark hover:bg-primary/90 transition shadow-lg shadow-primary/20">
                Continue to Payment
            </button>
        </aside>
    </div>
</main>

<script>
    function goToPayment() {
        const selected = document.querySelector('input[name="address_id"]:checked');
        if (!selected) {
            alert("Please select a delivery address before continuing.");
            return;
        }
        window.location.href = `/payment/${selected.value}/`;
    }
</script>

{% endblock %}