{% extends "shop/base_shop.html" %}
{% load static %}
{% block title %}Products - Shoeverse{% endblock %}

{% block content %}

<section class="max-w-container mx-auto px-5 md:px-10 space-y-8 pb-20">

    <header class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between mt-10">
        <div class="flex flex-col gap-2">
            <p class="text-sm uppercase tracking-[0.24em] text-muted">Discover</p>
            <h1 class="text-3xl font-bold">
                {% if category %}
                    Featured Shoes for {{ category|title }}
                {% else %}
                    Featured Shoes
                {% endif %}
            </h1>
            <p class="text-body text-muted max-w-2xl">
                Browse the latest drops and high-performance footwear.
            </p>
        </div>
    </header>

    <div class="grid lg:grid-cols-[320px_1fr] gap-6 xl:gap-8">

        {% include "shop/partials/filter_sidebar.html" %}

        <div class="space-y-6">

            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                <h2 class="text-2xl font-semibold text-white">
                    {{ products.paginator.count }} Products Found
                </h2>

                <form method="get" class="flex items-center gap-3">
                    {% for size in active_sizes %} <input type="hidden" name="size" value="{{ size }}"> {% endfor %}
                    {% if active_color %} <input type="hidden" name="color" value="{{ active_color }}"> {% endif %}
                    {% if category %} <input type="hidden" name="category" value="{{ category }}"> {% endif %}
                    {% if min_price %} <input type="hidden" name="min_price" value="{{ min_price }}"> {% endif %}
                    {% if max_price %} <input type="hidden" name="max_price" value="{{ max_price }}"> {% endif %}
                    {% if q %} <input type="hidden" name="q" value="{{ q }}"> {% endif %}
                    {% if active_subcategory %} <input type="hidden" name="subcategory" value="{{ active_subcategory }}"> {% endif %}

                    <select name="sort" onchange="this.form.submit()"
                            class="px-4 py-2 bg-[#18211d] border border-[#2a3b31] text-white rounded-lg focus:ring-1 focus:ring-[#96c4a8] outline-none cursor-pointer">
                        <option value="">Sort By</option>
                        <option value="new" {% if sort == "new" %}selected{% endif %}>Newest</option>
                        <option value="priceLow" {% if sort == "priceLow" %}selected{% endif %}>Price: Low to High</option>
                        <option value="priceHigh" {% if sort == "priceHigh" %}selected{% endif %}>Price: High to Low</option>
                        <option value="nameAsc" {% if sort == "nameAsc" %}selected{% endif %}>Name (A-Z)</option>
                        <option value="nameDesc" {% if sort == "nameDesc" %}selected{% endif %}>Name (Z-A)</option>
                    </select>
                </form>
            </div>


            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">

                {% for p in products %}
                <div class="group relative flex flex-col bg-[#18211d] border border-[#2a3b31] rounded-2xl overflow-hidden hover:border-[#96c4a8]/50 transition-all duration-300 hover:shadow-xl hover:shadow-[#96c4a8]/10 hover:-translate-y-1">
                    
                    <form method="POST" action="{% url 'add_to_wishlist' p.id %}" class="absolute top-3 right-3 z-20">
                        {% csrf_token %}
                        <button type="submit" 
                            class="w-9 h-9 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg backdrop-blur-sm
                            {% if p.id in wishlist_ids %}
                                bg-[#96c4a8] text-[#121714] scale-110 shadow-[#96c4a8]/30
                            {% else %}
                                bg-[#121714]/60 text-white hover:bg-[#96c4a8] hover:text-[#121714]
                            {% endif %}">
                            
                            {% if p.id in wishlist_ids %}
                                <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            {% else %}
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                            {% endif %}
                        </button>
                    </form>

                    <a href="{% url 'product_detail' p.id %}" class="block flex-1 flex flex-col">
                        
                        <div class="aspect-[4/5] bg-[#121714] overflow-hidden relative">
                            {% if p.images.first %}
                                <img src="{{ p.images.first.image.url }}" 
                                     alt="{{ p.name }}" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                            {% else %}
                                <div class="w-full h-full flex items-center justify-center text-gray-600 bg-[#0f1210]">No Image</div>
                            {% endif %}
                            
                            <div class="absolute inset-0 bg-gradient-to-t from-[#18211d] via-transparent to-transparent opacity-60"></div>
                        </div>
                        
                        <div class="p-5 flex flex-col flex-1">
                            
                            <div class="flex justify-between items-start mb-2">
                                <p class="text-[10px] font-bold text-[#96c4a8] uppercase tracking-wider bg-[#96c4a8]/10 px-2 py-0.5 rounded">
                                    {{ p.category }}
                                </p>
                                
                                {% if p.avg_rating > 0 %}
                                <div class="flex items-center gap-1 bg-[#2a3b31] px-2 py-0.5 rounded text-[10px] border border-[#3d5244] shadow-sm">
                                    <span class="text-white font-bold">{{ p.avg_rating|floatformat:1 }}</span>
                                    <svg class="w-3 h-3 text-yellow-400 fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                    <span class="text-gray-400 ml-0.5">({{ p.review_count }})</span>
                                </div>
                                {% endif %}
                            </div>

                            <h3 class="text-lg font-bold text-white mb-1 group-hover:text-[#96c4a8] transition-colors truncate">
                                {{ p.name }}
                            </h3>
                            
                            <p class="text-xs text-gray-500 mb-3">{{ p.color|title }}</p>

                            <div class="mt-auto flex items-baseline gap-2">
                                <span class="text-lg font-bold text-white">₹ {{ p.price }}</span>
                                {% if p.old_price %}
                                    <span class="text-sm text-gray-500 line-through">₹ {{ p.old_price }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>

                    <div class="px-5 pb-5 mt-auto">
                        {% if p.in_stock_count > 0 %}
                            {% if p.get_first_available_variant %}
                                <form action="{% url 'add_to_cart' p.get_first_available_variant.id %}" method="POST">
                                    {% csrf_token %}
                                    <button type="submit" 
                                        class="w-full py-2.5 rounded-lg bg-[#2a3b31] hover:bg-[#96c4a8] text-[#96c4a8] hover:text-[#121714] font-semibold text-sm transition-all border border-[#3d5244] flex items-center justify-center gap-2 group/btn shadow-md">
                                        <svg class="w-4 h-4 transition-transform group-hover/btn:-translate-y-0.5 group-hover/btn:translate-x-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                                        Add to Cart
                                    </button>
                                </form>
                            {% else %}
                                <a href="{% url 'product_detail' p.id %}" class="block w-full py-2.5 rounded-lg bg-[#2a3b31] text-white font-semibold text-sm text-center hover:bg-[#364a3e]">
                                    View Options
                                </a>
                            {% endif %}
                        {% else %}
                            <button disabled class="w-full py-2.5 rounded-lg bg-red-900/10 text-red-500 font-semibold text-sm border border-red-900/20 cursor-not-allowed opacity-70">
                                Out of Stock
                            </button>
                        {% endif %}
                    </div>

                </div>
                {% empty %}
                    <div class="col-span-full py-20 text-center">
                        <div class="w-16 h-16 bg-[#2a3b31] rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                        <h3 class="text-xl font-bold text-white">No products found</h3>
                        <p class="text-gray-400 mt-2">Try adjusting your search or filters.</p>
                        <a href="{% url 'shop_products' %}" class="inline-block mt-4 text-[#96c4a8] hover:underline">Clear all filters</a>
                    </div>
                {% endfor %}

            </div>

            {% if page_obj.has_other_pages %}
            <nav class="flex items-center justify-center gap-3 pt-10" aria-label="Pagination">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if page_query %}&{{ page_query }}{% endif %}"
                    class="w-10 h-10 flex items-center justify-center rounded-lg border border-[#2a3b31] text-gray-400 hover:text-white hover:border-[#96c4a8] hover:bg-[#96c4a8]/10 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span class="w-10 h-10 flex items-center justify-center rounded-lg bg-[#96c4a8] text-[#121714] font-bold shadow-lg shadow-[#96c4a8]/20">
                            {{ num }}
                        </span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% if page_query %}&{{ page_query }}{% endif %}"
                        class="w-10 h-10 flex items-center justify-center rounded-lg border border-[#2a3b31] text-gray-400 hover:text-white hover:bg-[#2a3b31] transition-all">
                            {{ num }}
                        </a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if page_query %}&{{ page_query }}{% endif %}"
                    class="w-10 h-10 flex items-center justify-center rounded-lg border border-[#2a3b31] text-gray-400 hover:text-white hover:border-[#96c4a8] hover:bg-[#96c4a8]/10 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </a>
                {% endif %}
            </nav>
            {% endif %}

        </div>

    </div>
</section>

{% endblock %}