{% extends 'adminpanel/base_admin.html' %}
{% load static %}

{% block title %}Support Dashboard{% endblock %}

{% block content %}
<div class="p-6 min-h-screen bg-[#09090b] text-zinc-100 font-sans">

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8 border-b border-zinc-800/50 pb-6">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight">Support Inbox</h1>
            <p class="text-zinc-400 text-sm mt-1">Manage and resolve customer inquiries.</p>
        </div>

        <span class="px-4 py-2 bg-zinc-900 border border-zinc-800 rounded-lg text-sm font-medium text-zinc-400">
            <span class="text-white font-bold">{{ tickets.count }}</span> Total Tickets
        </span>
    </div>

    <!-- Tickets Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

        {% for ticket in tickets %}
        <div class="group bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden shadow-md
                    hover:border-zinc-600 transition-all flex flex-col relative">

            <!-- Status Badge -->
            <div class="absolute top-3 right-3 z-10">
                {% if ticket.status == 'OPEN' %}
                    <span class="badge bg-red-500/10 text-red-400 border-red-500/20">Open</span>
                {% elif ticket.status == 'IN_PROGRESS' %}
                    <span class="badge bg-amber-500/10 text-amber-400 border-amber-500/20">In Progress</span>
                {% else %}
                    <span class="badge bg-emerald-500/10 text-emerald-400 border-emerald-500/20">Resolved</span>
                {% endif %}
            </div>

            <!-- Ticket Header -->
            <div class="h-32 bg-gradient-to-br from-zinc-900 to-zinc-950 border-b border-zinc-800
                        p-5 flex flex-col justify-end">

                <span class="absolute top-4 left-4 font-mono text-xs text-zinc-500">
                    #{{ ticket.ticket_id }}
                </span>

                <p class="text-blue-400 text-[10px] font-bold uppercase tracking-wider mb-1">
                    {{ ticket.user.username }}
                </p>
                <h3 class="text-white font-bold text-lg truncate pr-16">
                    {{ ticket.subject }}
                </h3>
            </div>

            <!-- Body -->
            <div class="p-4 flex flex-col justify-between flex-1">

                <!-- Last Message -->
                <div class="mb-4">
                    <p class="text-zinc-500 text-xs font-bold uppercase mb-2">
                        Latest Activity
                    </p>

                    {% with ticket.messages.last as last_msg %}
                        {% if last_msg %}
                            <p class="text-zinc-300 text-sm line-clamp-2">
                                <span class="text-zinc-500">
                                    {% if last_msg.user.is_staff %}
                                        Admin:
                                    {% else %}
                                        {{ ticket.user.username }}:
                                    {% endif %}
                                </span>
                                {{ last_msg.message }}
                            </p>
                        {% else %}
                            <p class="text-zinc-600 text-sm italic">No messages yet.</p>
                        {% endif %}
                    {% endwith %}
                </div>

                <!-- Footer -->
                <div class="flex items-center justify-between pt-4 border-t border-zinc-800 mt-auto">

                    <div>
                        <p class="text-[10px] uppercase text-zinc-500 font-bold">Last Update</p>
                        <p class="text-xs text-zinc-400 font-mono">
                            {{ ticket.updated_at|timesince }} ago
                        </p>
                    </div>

                    <a href="{% url 'admin_ticket_chat' ticket.id %}"
                       class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium
                              bg-zinc-800 text-zinc-300 border border-zinc-700
                              hover:bg-blue-600 hover:text-white transition">
                        Open Chat
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full py-20 text-center bg-zinc-900 border-2 border-dashed border-zinc-800 rounded-xl">
            <h3 class="text-white font-bold text-lg mb-2">All Caught Up ðŸŽ‰</h3>
            <p class="text-zinc-500 text-sm">There are no support tickets right now.</p>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    font-size: 10px;
    font-weight: 700;
    border-radius: 9999px;
    border: 1px solid;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
</style>
{% endblock %}
